<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.title }} — {{ site.title }}</title>

    <link rel="stylesheet" href="/css/blog.css" />
    <link rel="stylesheet" href="/css/projects.css" />

    {% include mathjax.html %}
  </head>

  <body class="projects-page">
    {% include nav.html %}

    <main class="projects-wrap">
      <header class="projects-hero">
        <div class="hero-kicker">PORTFOLIO</div>
        <h1 class="hero-title">{{ page.title | default: "Projects" }}</h1>
        <p class="hero-subtitle">
          A curated list of missions, simulations, and tools. Minimal, documented, and continuously improved.
        </p>

        <div class="hero-actions">
          <a class="hero-action" href="#featured">Featured</a>
          <a class="hero-action" href="#browse">Browse</a>
          <a class="hero-action" href="#tags">Tags</a>
        </div>

        <div class="hero-rule"></div>
      </header>

      {% assign projects = site.data.projects %}
      {% if projects == nil %}
        {% assign projects = "" | split: "" %}
      {% endif %}

      {% assign projects_sorted = projects | sort: "year" | reverse %}
      {% assign featured = projects_sorted | where: "featured", true %}

      {%- comment -%}
      Build a unique tag list.
      {%- endcomment -%}
      {% assign tag_string = "" %}
      {% for p in projects_sorted %}
        {% if p.tags %}
          {% for t in p.tags %}
            {% assign tag_string = tag_string | append: t | append: "|" %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      {% assign tags_all = tag_string | split: "|" | sort %}
      {% assign tags_unique = "" | split: "" %}
      {% for t in tags_all %}
        {% if t != "" %}
          {% if tags_unique contains t %}
          {% else %}
            {% assign tags_unique = tags_unique | push: t %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {% if featured and featured.size > 0 %}
      <section id="featured" class="projects-section">
        <div class="section-head">
          <div class="section-title">Featured missions</div>
          <div class="section-meta">hand-picked</div>
        </div>

        <div class="featured-grid">
          {% for p in featured %}
          <article class="card card-featured">
            <div class="card-top">
              <div class="meta">
                {% if p.status %}<span class="pill">{{ p.status }}</span>{% endif %}
                {% if p.year %}<span class="dot">•</span><span class="meta-text">{{ p.year }}</span>{% endif %}
                {% if p.category %}<span class="dot">•</span><span class="meta-text">{{ p.category }}</span>{% endif %}
              </div>
              <h2 class="card-title">{{ p.title }}</h2>
              {% if p.role %}
              <div class="card-role">{{ p.role }}</div>
              {% endif %}
            </div>

            {% if p.image %}
            <div class="thumb">
              <img src="{{ p.image }}" alt="{{ p.title }} thumbnail" loading="lazy" />
            </div>
            {% endif %}

            {% if p.summary %}
            <p class="card-summary">{{ p.summary }}</p>
            {% endif %}

            {% if p.tags %}
            <div class="chips">
              {% for t in p.tags %}
                <a class="chip chip-link tag-jump" href="#tag-{{ t | slugify }}" data-tag="{{ t | slugify }}">{{ t }}</a>
              {% endfor %}
            </div>
            {% endif %}

            <div class="card-links">
              {% if p.slug %}
                <a class="link" href="/projects/{{ p.slug }}/">Brief</a>
              {% endif %}
              {% if p.links %}
                {% for l in p.links %}
                  <a class="link" href="{{ l.url }}">{{ l.label }}</a>
                {% endfor %}
              {% endif %}
            </div>
          </article>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <section id="tags" class="projects-section">
        <div class="section-head">
          <div class="section-title">Tags</div>
          <div class="section-meta">
            <span id="filterCount">{{ projects_sorted | size }}</span>/<span id="totalCount">{{ projects_sorted | size }}</span>
          </div>
        </div>

        {% if tags_unique == nil or tags_unique.size == 0 %}
          <div class="empty-state">
            <p>No tags yet. Add <code>tags</code> arrays to projects in <code>_data/projects.yml</code>.</p>
          </div>
        {% else %}
          <div class="tag-cloud" id="tagCloud">
            <button class="tag-pill tag-pill-clear" id="clearTag" type="button" aria-pressed="false" hidden>
              Clear
            </button>

            {% for t in tags_unique %}
              <button
                class="tag-pill tag-filter"
                type="button"
                data-tag="{{ t | slugify }}"
                aria-pressed="false"
              >
                {{ t }}
              </button>
            {% endfor %}
          </div>

          <div class="filter-hint" id="filterHint" hidden>
            Filtering by: <span class="filter-name" id="filterName"></span>
          </div>
        {% endif %}
      </section>

      <section id="browse" class="projects-section">
        <div class="section-head">
          <div class="section-title">Browse</div>
          <div class="section-meta">all projects</div>
        </div>

        {% if projects_sorted == nil or projects_sorted.size == 0 %}
          <div class="empty-state">
            <p>
              No projects loaded yet.
              Create <code>_data/projects.yml</code> and add entries to populate this page.
            </p>
          </div>
        {% else %}
          <div class="cards-grid" id="projectsGrid">
            {% for p in projects_sorted %}
              {%- assign tags_attr = "" -%}
              {%- if p.tags -%}
                {%- for tt in p.tags -%}
                  {%- assign tags_attr = tags_attr | append: tt | slugify | append: " " -%}
                {%- endfor -%}
              {%- endif -%}

              <article class="card project-card" data-tags="{{ tags_attr | strip }}">
                <div class="card-top">
                  <div class="meta">
                    {% if p.status %}<span class="pill">{{ p.status }}</span>{% endif %}
                    {% if p.year %}<span class="dot">•</span><span class="meta-text">{{ p.year }}</span>{% endif %}
                    {% if p.category %}<span class="dot">•</span><span class="meta-text">{{ p.category }}</span>{% endif %}
                  </div>
                  <h2 class="card-title">{{ p.title }}</h2>
                  {% if p.role %}
                  <div class="card-role">{{ p.role }}</div>
                  {% endif %}
                </div>

                {% if p.summary %}
                <p class="card-summary">{{ p.summary }}</p>
                {% endif %}

                {% if p.tags %}
                <div class="chips">
                  {% for t in p.tags %}
                    <a class="chip chip-link tag-jump" href="#tag-{{ t | slugify }}" data-tag="{{ t | slugify }}">{{ t }}</a>
                  {% endfor %}
                </div>
                {% endif %}

                <div class="card-links">
                  {% if p.slug %}
                    <a class="link" href="/projects/{{ p.slug }}/">Brief</a>
                  {% endif %}
                  {% if p.links %}
                    {% for l in p.links %}
                      <a class="link" href="{{ l.url }}">{{ l.label }}</a>
                    {% endfor %}
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          </div>
        {% endif %}
      </section>

      <footer class="projects-footer">
        <div class="footer-rule"></div>
        <div class="footer-text">Last updated: {{ "now" | date: "%Y-%m-%d" }}</div>
      </footer>
    </main>

    <script>
      (function () {
        const grid = document.getElementById("projectsGrid");
        const tagCloud = document.getElementById("tagCloud");
        if (!grid || !tagCloud) return;

        const cards = Array.from(grid.querySelectorAll(".project-card"));
        const tagButtons = Array.from(tagCloud.querySelectorAll(".tag-filter"));
        const clearBtn = document.getElementById("clearTag");
        const filterCount = document.getElementById("filterCount");
        const filterHint = document.getElementById("filterHint");
        const filterName = document.getElementById("filterName");

        const total = cards.length;

        function setHash(tag) {
          if (!tag) {
            history.replaceState(null, "", location.pathname + location.search);
            return;
          }
          history.replaceState(null, "", "#tag-" + tag);
        }

        function getHashTag() {
          const h = (location.hash || "").trim();
          if (!h.startsWith("#tag-")) return "";
          return h.replace("#tag-", "").trim();
        }

        function updateUI(activeTag) {
          // buttons state
          tagButtons.forEach(btn => {
            const isActive = btn.dataset.tag === activeTag;
            btn.classList.toggle("is-active", isActive);
            btn.setAttribute("aria-pressed", isActive ? "true" : "false");
          });

          // clear button + hint
          const hasFilter = !!activeTag;
          clearBtn.hidden = !hasFilter;
          clearBtn.setAttribute("aria-pressed", hasFilter ? "true" : "false");
          filterHint.hidden = !hasFilter;
          if (hasFilter) filterName.textContent = activeTag;

          // filter cards
          let visible = 0;
          cards.forEach(card => {
            if (!activeTag) {
              card.hidden = false;
              visible++;
              return;
            }
            const tags = (card.dataset.tags || "").split(/\s+/).filter(Boolean);
            const ok = tags.includes(activeTag);
            card.hidden = !ok;
            if (ok) visible++;
          });

          filterCount.textContent = String(visible);
        }

        function applyTag(tag) {
          const active = tag || "";
          setHash(active);
          updateUI(active);
          // move focus/scroll to grid for a "nice" feeling
          const browse = document.getElementById("browse");
          if (browse) browse.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // click on tag pills
        tagButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            const tag = btn.dataset.tag;
            const current = getHashTag();
            // toggle behavior
            applyTag(current === tag ? "" : tag);
          });
        });

        // clear
        clearBtn.addEventListener("click", () => applyTag(""));

        // clicking chips inside cards should filter too (no need accordion)
        document.querySelectorAll(".tag-jump").forEach(a => {
          a.addEventListener("click", (e) => {
            const tag = a.dataset.tag;
            if (!tag) return;
            e.preventDefault();
            applyTag(tag);
          });
        });

        // init from URL hash
        const initial = getHashTag();
        updateUI(initial);

        // respond to manual hash change
        window.addEventListener("hashchange", () => {
          updateUI(getHashTag());
        });
      })();
    </script>
  </body>
</html>
